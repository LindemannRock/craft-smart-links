{% import "_includes/forms" as forms %}

{% set storageMethod = settings.cacheStorageMethod %}

<div style="margin-bottom: 32px;">
	<h2>{{ smartlinkHelper.fullName }}
		{{ "Overview"|t('smart-links') }}</h2>
	<p class="light">{{ "Monitor link performance, track analytics, and manage cache for your {singularName} redirects and QR codes."|t('smart-links', {singularName: smartlinkHelper.lowerDisplayName}) }}</p>
</div>

<div style="margin-bottom: 40px;">
	<h2>{{ "System Overview"|t('smart-links') }}</h2>

	<div
		style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; align-items: stretch;">
		<!-- Links Status Card -->
		<div
			class="pane" style="padding: 24px; margin-block: 0; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); display: flex; flex-direction: column; height: 100%;">
			<!-- Header -->
			<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
				<div style="width: 12px; height: 12px; border-radius: 50%; background: #22c55e;"></div>
				<h4 style="margin: 0; color: #374151; font-size: 15px; font-weight: 600;">{{ "Links Status"|t('smart-links') }}</h4>
			</div>

			<!-- Main Content -->
			<div style="flex: 1; display: flex; flex-direction: column;">
				<div style="font-size: 28px; font-weight: 700; color: #0f172a; line-height: 1; margin-bottom: 12px;">
					{{ totalLinks|number_format }}
				</div>
				<div style="font-size: 14px; color: #4b5563; margin-bottom: 12px;">
					{{ "Total {pluginName}"|t('smart-links', {pluginName: smartlinkHelper.pluralLowerDisplayName}) }}
				</div>

				<!-- Bottom Boxes (max 3, hide zeros by priority: disabled, pending, expired) -->
				<div style="margin-top: auto;">
					{% set visibleBoxes = [] %}
					{% set visibleBoxes = visibleBoxes|merge([{value: activeLinks, label: 'Active'|t('smart-links')}]) %}
					{% if pendingLinks > 0 or (expiredLinks == 0 and disabledLinks == 0) %}
						{% set visibleBoxes = visibleBoxes|merge([{value: pendingLinks, label: 'Pending'|t('smart-links')}]) %}
					{% endif %}
					{% if expiredLinks > 0 or (pendingLinks == 0 and disabledLinks == 0) %}
						{% set visibleBoxes = visibleBoxes|merge([{value: expiredLinks, label: 'Expired'|t('smart-links')}]) %}
					{% endif %}
					{% if disabledLinks > 0 and visibleBoxes|length < 3 %}
						{% set visibleBoxes = visibleBoxes|merge([{value: disabledLinks, label: 'Disabled'|t('smart-links')}]) %}
					{% endif %}

					<div style="display: grid; grid-template-columns: repeat({{ visibleBoxes|length }}, 1fr); gap: 8px;">
						{% for box in visibleBoxes %}
						<div style="padding: 12px; background: rgba(255,255,255,0.9); border: 1px solid #e5e7eb; border-radius: 8px; text-align: center; min-height: 60px; display: flex; flex-direction: column; justify-content: center;">
							<div style="font-size: 16px; font-weight: 600; color: #374151; margin-bottom: 4px;">{{ box.value|number_format }}</div>
							<div style="font-size: 11px; color: #4b5563; text-transform: uppercase;">{{ box.label }}</div>
						</div>
						{% endfor %}
					</div>
				</div>
			</div>
		</div>

		{% if settings.enableAnalytics %}
			<!-- Performance Card -->
			<div
				class="pane" style="padding: 24px; margin-block: 0; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); display: flex; flex-direction: column; height: 100%;">
				<!-- Header -->
				<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
					<div style="width: 12px; height: 12px; border-radius: 50%; background: #0ea5e9;"></div>
					<h4 style="margin: 0; color: #374151; font-size: 15px; font-weight: 600;">{{ "Performance"|t('smart-links') }}</h4>
				</div>

				<!-- Main Content -->
				<div style="flex: 1; display: flex; flex-direction: column;">
					<div style="display: flex; align-items: baseline; gap: 12px; margin-bottom: 12px;">
						<div style="font-size: 28px; font-weight: 700; color: #0f172a; line-height: 1;">
							{{ totalClicks|number_format }}
						</div>
					</div>
					<div style="font-size: 14px; color: #4b5563; margin-bottom: 12px;">
						{{ "Total interactions tracked"|t('smart-links') }}
					</div>

					<!-- Bottom Boxes -->
					<div style="margin-top: auto;">
						<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
							<div style="padding: 12px; background: rgba(255,255,255,0.9); border: 1px solid #e5e7eb; border-radius: 8px; text-align: center; min-height: 60px; display: flex; flex-direction: column; justify-content: center;">
								<div style="font-size: 16px; font-weight: 600; color: #374151; margin-bottom: 4px;">{{ qrScans|number_format }}</div>
								<div style="font-size: 11px; color: #4b5563; text-transform: uppercase;">{{ 'QR Scans'|t('smart-links') }}</div>
							</div>
							<div style="padding: 12px; background: rgba(255,255,255,0.9); border: 1px solid #e5e7eb; border-radius: 8px; text-align: center; min-height: 60px; display: flex; flex-direction: column; justify-content: center;">
								<div style="font-size: 16px; font-weight: 600; color: #374151; margin-bottom: 4px;">{{ autoRedirects|number_format }}</div>
								<div style="font-size: 11px; color: #4b5563; text-transform: uppercase;">{{ 'Redirects'|t('smart-links') }}</div>
							</div>
							<div style="padding: 12px; background: rgba(255,255,255,0.9); border: 1px solid #e5e7eb; border-radius: 8px; text-align: center; min-height: 60px; display: flex; flex-direction: column; justify-content: center;">
								<div style="font-size: 16px; font-weight: 600; color: #374151; margin-bottom: 4px;">{{ buttonClicks|number_format }}</div>
								<div style="font-size: 11px; color: #4b5563; text-transform: uppercase;">{{ 'Clicks'|t('smart-links') }}</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		{% endif %}

		<!-- Cache Status Card -->
		<div
			class="pane" style="padding: 24px; margin-block: 0; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); display: flex; flex-direction: column; height: 100%;">
			<!-- Header -->
			<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
				<div style="width: 12px; height: 12px; border-radius: 50%; background: #22c55e;"></div>
				<h4 style="margin: 0; color: #374151; font-size: 15px; font-weight: 600;">
					{{ "Cache Status"|t('smart-links') }} ({{ storageMethod == 'redis' ? 'Redis' : 'File' }})
				</h4>
			</div>

			<!-- Main Content -->
			<div style="flex: 1; display: flex; flex-direction: column;">
				{% if storageMethod == 'redis' %}
					<div style="font-size: 28px; font-weight: 700; color: #0f172a; line-height: 1; margin-bottom: 12px;">
						{{ "Active"|t('smart-links') }}
					</div>
					<div style="font-size: 14px; color: #4b5563; margin-bottom: 12px;">
						{{ "Cached via Redis"|t('smart-links') }}
					</div>

					<!-- Info Boxes -->
					<div style="margin-top: auto;">
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
							{% if settings.enableQrCodeCache %}
							<div style="padding: 12px; background: rgba(255,255,255,0.9); border: 1px solid #e5e7eb; border-radius: 8px; text-align: center; min-height: 60px; display: flex; flex-direction: column; justify-content: center;">
								<div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 4px;">✓</div>
								<div style="font-size: 11px; color: #4b5563; text-transform: uppercase;">{{ 'QR Codes'|t('smart-links') }}</div>
							</div>
							{% endif %}
							{% if settings.cacheDeviceDetection %}
							<div style="padding: 12px; background: rgba(255,255,255,0.9); border: 1px solid #e5e7eb; border-radius: 8px; text-align: center; min-height: 60px; display: flex; flex-direction: column; justify-content: center;">
								<div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 4px;">✓</div>
								<div style="font-size: 11px; color: #4b5563; text-transform: uppercase;">{{ 'Devices'|t('smart-links') }}</div>
							</div>
							{% endif %}
						</div>
					</div>
				{% else %}
					<div style="display: flex; align-items: baseline; gap: 12px; margin-bottom: 12px;">
						<div style="font-size: 28px; font-weight: 700; color: #0f172a; line-height: 1;">
							{{ (qrCacheFiles + deviceCacheFiles)|number_format }}
						</div>
					</div>
					<div style="font-size: 14px; color: #4b5563; margin-bottom: 12px;">
						{{ "Total cached entries"|t('smart-links') }}
					</div>

					<!-- Bottom Boxes -->
					<div style="margin-top: auto;">
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
							<div style="padding: 12px; background: rgba(255,255,255,0.9); border: 1px solid #e5e7eb; border-radius: 8px; text-align: center; min-height: 60px; display: flex; flex-direction: column; justify-content: center;">
								<div style="font-size: 16px; font-weight: 600; color: #374151; margin-bottom: 4px;">{{ qrCacheFiles|number_format }}</div>
								<div style="font-size: 11px; color: #4b5563; text-transform: uppercase;">{{ 'QR Codes'|t('smart-links') }}</div>
							</div>
							<div style="padding: 12px; background: rgba(255,255,255,0.9); border: 1px solid #e5e7eb; border-radius: 8px; text-align: center; min-height: 60px; display: flex; flex-direction: column; justify-content: center;">
								<div style="font-size: 16px; font-weight: 600; color: #374151; margin-bottom: 4px;">{{ deviceCacheFiles|number_format }}</div>
								<div style="font-size: 11px; color: #4b5563; text-transform: uppercase;">{{ 'Devices'|t('smart-links') }}</div>
							</div>
						</div>
					</div>
				{% endif %}
			</div>
		</div>
	</div>
</div>

<!-- Quick Actions -->
<div style="margin-bottom: 40px;">
	<h2>{{ 'Quick Actions'|t('smart-links') }}</h2>

	<div class="pane">
		<div style="margin-bottom: 24px;">
			<h3 style="margin-bottom: 8px;">{{ "Navigation"|t('smart-links') }}</h3>
			<p class="light" style="margin-bottom: 16px;">{{ "Access main plugin sections"|t('smart-links') }}</p>
			<div style="display: flex; gap: 10px; flex-wrap: wrap;">
				<a href="{{ url('smart-links') }}" class="btn">
					{{ "Manage {pluginName}"|t('smart-links', {pluginName: smartlinkHelper.pluralDisplayName}) }}
				</a>
				{% if settings.enableAnalytics %}
					<a href="{{ url('smart-links/analytics') }}" class="btn">
						{{ "View Analytics"|t('smart-links') }}
					</a>
				{% endif %}
				<a href="{{ url('smart-links/settings') }}" class="btn">
					{{ "View Settings"|t('smart-links') }}
				</a>
			</div>
		</div>


		{% if settings.enableQrCodeCache or settings.cacheDeviceDetection %}
			<hr style="margin: 24px 0;">

			<div>
				<h3 style="margin-bottom: 8px;">{{ "Cache Management"|t('smart-links') }}</h3>
				<p class="light" style="margin-bottom: 16px;">{{ "Clear cached data to force regeneration. Useful after changing QR code settings or when troubleshooting."|t('smart-links') }}</p>

				<div style="display: flex; gap: 10px; flex-wrap: wrap;">
					{% if settings.enableQrCodeCache %}
						<button type="button" class="btn" id="clear-qr-cache">
							{{ "Clear QR Cache"|t('smart-links') }}{% if storageMethod != 'redis' %} ({{ qrCacheFiles }}){% endif %}
						</button>
					{% endif %}

					{% if settings.cacheDeviceDetection %}
						<button type="button" class="btn" id="clear-device-cache">
							{{ "Clear Device Cache"|t('smart-links') }}{% if storageMethod != 'redis' %} ({{ deviceCacheFiles }}){% endif %}
						</button>
					{% endif %}

					{% if settings.enableQrCodeCache and settings.cacheDeviceDetection %}
						<button type="button" class="btn secondary" id="clear-all-caches">
							{{ "Clear All Caches"|t('smart-links') }}{% if storageMethod != 'redis' %} ({{ (qrCacheFiles + deviceCacheFiles) }}){% endif %}
						</button>
					{% endif %}
				</div>
			</div>
		{% endif %}

		{% if settings.enableAnalytics %}
			<hr style="margin: 24px 0;">

			<div>
				<h3 style="margin-bottom: 8px;">{{ "Analytics Data Management"|t('smart-links') }}</h3>
				<p class="light" style="margin-bottom: 16px;">{{ "Permanently delete all analytics tracking data. This action cannot be undone!"|t('smart-links') }}</p>

				<div style="display: flex; gap: 10px; flex-wrap: wrap;">
					<button type="button" class="btn submit" id="clear-all-analytics" style="background: #dc2626; border-color: #dc2626; color: white;">
						{{ "Clear All Analytics"|t('smart-links') }}
					</button>
				</div>
			</div>
		{% endif %}
	</div>
</div>

{% js %}
// Cache clearing handlers
{% if settings.qrCodeCacheDuration > 0 %}
	$('#clear-qr-cache').on('click', function() {
		    const $btn = $(this);
		    $btn.addClass('loading').prop('disabled', true);
	
		    $.ajax({
		        url: '{{ actionUrl('smart-links/settings/clear-qr-cache')|raw }}',
		        type: 'POST',
		        dataType: 'json',
		        data: {
	{{ craft.app.config.general.csrfTokenName }}: '{{ craft.app.request.csrfToken }}'
		        },
		        success: function(response) {
		            if (response.success) {
		                Craft.cp.displayNotice(response.message);
		                setTimeout(() => window.location.reload(), 1500);
		            } else {
		                Craft.cp.displayError(response.error || '{{ "Failed to clear QR cache"|t('smart-links')|e('js') }}');
		            }
		        },
		        error: function() {
		            Craft.cp.displayError('{{ "Failed to clear QR cache"|t('smart-links')|e('js') }}');
		        },
		        complete: function() {
		            $btn.removeClass('loading').prop('disabled', false);
		        }
		    });
		});
{% endif %}

{% if settings.cacheDeviceDetection %}
	$('#clear-device-cache').on('click', function() {
		    const $btn = $(this);
		    $btn.addClass('loading').prop('disabled', true);
	
		    $.ajax({
		        url: '{{ actionUrl('smart-links/settings/clear-device-cache')|raw }}',
		        type: 'POST',
		        dataType: 'json',
		        data: {
	{{ craft.app.config.general.csrfTokenName }}: '{{ craft.app.request.csrfToken }}'
		        },
		        success: function(response) {
		            if (response.success) {
		                Craft.cp.displayNotice(response.message);
		                setTimeout(() => window.location.reload(), 1500);
		            } else {
		                Craft.cp.displayError(response.error || '{{ "Failed to clear device cache"|t('smart-links')|e('js') }}');
		            }
		        },
		        error: function() {
		            Craft.cp.displayError('{{ "Failed to clear device cache"|t('smart-links')|e('js') }}');
		        },
		        complete: function() {
		            $btn.removeClass('loading').prop('disabled', false);
		        }
		    });
		});
{% endif %}

$('#clear-all-caches').on('click', function() {
    if (!confirm('{{ "Are you sure you want to clear all {pluginName} caches?"|t('smart-links', { pluginName: smartlinkHelper.fullName })|e('js') }}')) {
        return;
    }

    const $btn = $(this);
    $btn.addClass('loading').prop('disabled', true);

    $.ajax({
        url: '{{ actionUrl('smart-links/settings/clear-all-caches')|raw }}',
        type: 'POST',
        dataType: 'json',
        data: {
{{ craft.app.config.general.csrfTokenName }}: '{{ craft.app.request.csrfToken }}'
        },
        success: function(response) {
            if (response.success) {
                Craft.cp.displayNotice(response.message);
                setTimeout(() => window.location.reload(), 1500);
            } else {
                Craft.cp.displayError(response.error || '{{ "Failed to clear caches"|t('smart-links')|e('js') }}');
            }
        },
        error: function() {
            Craft.cp.displayError('{{ "Failed to clear caches"|t('smart-links')|e('js') }}');
        },
        complete: function() {
            $btn.removeClass('loading').prop('disabled', false);
        }
    });
});

{% if settings.enableAnalytics %}
	$('#clear-all-analytics').on('click', function() {
		    if (!confirm('{{ "Are you sure you want to permanently delete ALL analytics data? This action cannot be undone!"|t('smart-links')|e('js') }}')) {
		        return;
		    }
	
		    // Second confirmation for extra safety
		    if (!confirm('{{ "This will delete all click tracking data and reset all click counts. Are you absolutely sure?"|t('smart-links')|e('js') }}')) {
		        return;
		    }
	
		    const $btn = $(this);
		    $btn.addClass('loading').prop('disabled', true);
	
		    $.ajax({
		        url: '{{ actionUrl('smart-links/settings/clear-all-analytics')|raw }}',
		        type: 'POST',
		        dataType: 'json',
		        data: {
	{{ craft.app.config.general.csrfTokenName }}: '{{ craft.app.request.csrfToken }}'
		        },
		        success: function(response) {
		            if (response.success) {
		                Craft.cp.displayNotice(response.message);
		                setTimeout(() => window.location.reload(), 2000);
		            } else {
		                Craft.cp.displayError(response.error || '{{ "Failed to clear analytics"|t('smart-links')|e('js') }}');
		            }
		        },
		        error: function() {
		            Craft.cp.displayError('{{ "Failed to clear analytics"|t('smart-links')|e('js') }}');
		        },
		        complete: function() {
		            $btn.removeClass('loading').prop('disabled', false);
		        }
		    });
		});
{% endif %}
{% endjs %}

{% include 'smart-links/_components/plugin-credit.twig' %}
