{% extends "smart-links/_layouts/settings" %}
{% set title = "General Settings"|t('smart-links') %}
{% set fullPageForm = true %}
{% set selectedSettingsItem = 'general' %}

{% set plugin = craft.app.plugins.getPlugin('smart-links') %}
{% set crumbs = [
    {
        label: plugin.settings.pluginName|t('smart-links'),
        url: url('smart-links'),
    },
    {
        label: 'Settings'|t('smart-links'),
        url: url('smart-links/settings'),
    },
    {
        label: 'General'|t('smart-links'),
        url: url('smart-links/settings/general'),
    },
] %}

{% import "_includes/forms" as forms %}

{% block content %}
    {% set pluginName = plugin.settings.pluginName %}
    {% set singularName = pluginName|replace({'/s$/': ''}) %}

    {% include 'smart-links/_components/ip-salt-error' %}

    <form method="post" accept-charset="UTF-8">
        {{ actionInput('smart-links/settings/save') }}
        {{ csrfInput() }}
        {{ redirectInput('smart-links/settings/general') }}
        {{ hiddenInput('section', 'general') }}

        <h2 style="margin-top: 0px;">{{ "Plugin Settings"|t('smart-links') }}</h2>

        {{ forms.textField({
            label: "Plugin Name"|t('smart-links'),
            instructions: "The name of the plugin as it appears in the Control Panel menu"|t('smart-links'),
            id: 'pluginName',
            name: 'settings[pluginName]',
            value: settings.pluginName,
            disabled: settings.isOverriddenByConfig('pluginName'),
            warning: settings.isOverriddenByConfig('pluginName') ?
                "This is being overridden by the <code>pluginName</code> setting in <code>config/smart-links.php</code>."|t('smart-links')|raw : null,
        }) }}

        <hr>

        <h2>{{ "Site Settings"|t('smart-links') }}</h2>

        {# Site selection checkboxes #}
        {% set siteOptions = [] %}
        {% for site in craft.app.sites.getAllSites() %}
            {% set siteOptions = siteOptions|merge([{
                label: site.name,
                value: site.id
            }]) %}
        {% endfor %}

        {{ forms.checkboxGroupField({
            label: "Enabled Sites"|t('smart-links'),
            instructions: "Select which sites {pluginName} should be enabled for. Leave empty to enable for all sites."|t('smart-links', {pluginName: pluginName}),
            id: 'enabledSites',
            name: 'settings[enabledSites]',
            options: siteOptions,
            values: settings.enabledSites ?? [],
            disabled: settings.isOverriddenByConfig('enabledSites'),
            warning: settings.isOverriddenByConfig('enabledSites') ?
                "This is being overridden by the <code>enabledSites</code> setting in <code>config/smart-links.php</code>."|t('smart-links')|raw : null,
        }) }}


        <hr>

        <h2>{{ "URL Settings"|t('smart-links') }}</h2>

        {% set redirectPlugin = craft.app.plugins.getPlugin('redirect-manager') %}
        {% set redirectActive = redirectPlugin and craft.app.plugins.isPluginEnabled('redirect-manager') %}
        {% set redirectPluginName = redirectPlugin ? (redirectPlugin.settings.pluginName ?? 'Redirect Manager') : 'Redirect Manager' %}

        {% set slugTip = redirectActive
            ? "Changing will break existing URLs. To migrate, create wildcard redirect in " ~ redirectPluginName ~ ": Source '/old/*' → Destination '/new/$1' (Match Type: Wildcard)"
            : "Changing the URL prefix will break all existing smart links. Only change this before creating your first smart link."
        %}

        {{ forms.textField({
            label: "{singularName} URL Prefix"|t('smart-links', {singularName: singularName}),
            instructions: "The URL prefix for {pluginName} (e.g., 'go' creates /go/your-link)"|t('smart-links', {pluginName: pluginName|lower}),
            id: 'slugPrefix',
            name: 'settings[slugPrefix]',
            value: settings.slugPrefix ?? 'go',
            errors: settings.getErrors('slugPrefix'),
            placeholder: 'go',
            required: true,
            tip: slugTip|t('smart-links'),
            disabled: settings.isOverriddenByConfig('slugPrefix'),
            warning: settings.isOverriddenByConfig('slugPrefix') ?
                "This is being overridden by the <code>slugPrefix</code> setting in <code>config/smart-links.php</code>."|t('smart-links')|raw : null,
        }) }}

        {% set qrTip = redirectActive
            ? "Changing will break existing QR URLs. To migrate, create wildcard redirect in " ~ redirectPluginName ~ ": Source '/old/*' → Destination '/new/$1' (Match Type: Wildcard). Supports standalone (e.g., 'qr') or nested (e.g., 'go/qr') patterns."
            : "Supports standalone (e.g., 'qr') or nested (e.g., 'go/qr') patterns. Checked for conflicts with ShortLink Manager."
        %}

        {# Calculate smart default for qrPrefix if empty #}
        {% set qrPrefixValue = settings.qrPrefix %}
        {% if qrPrefixValue is empty %}
            {# Try nested pattern first (safer and more organized) #}
            {% set nestedDefault = settings.slugPrefix ~ '/qr' %}
            {% set smartQrDefault = nestedDefault %}

            {% set shortlinkPlugin = craft.app.plugins.getPlugin('shortlink-manager') %}
            {% if shortlinkPlugin and craft.app.plugins.isPluginEnabled('shortlink-manager') %}
                {% set shortlinkSettings = shortlinkPlugin.getSettings() %}
                {% set conflictingPrefixes = [
                    shortlinkSettings.slugPrefix ?? 's',
                    shortlinkSettings.qrPrefix ?? 's/qr',
                ] %}

                {# Check if nested pattern conflicts with ShortLink Manager #}
                {% if nestedDefault in conflictingPrefixes %}
                    {# Try standalone alternatives #}
                    {% set found = false %}
                    {% for candidate in ['qr', 'gqr', 'q', 'go-qr'] %}
                        {% if not found and candidate not in conflictingPrefixes and candidate != settings.slugPrefix %}
                            {% set smartQrDefault = candidate %}
                            {% set found = true %}
                        {% endif %}
                    {% endfor %}
                {% endif %}
            {% endif %}

            {% set qrPrefixValue = smartQrDefault %}
        {% endif %}

        {{ forms.textField({
            label: "QR Code URL Prefix"|t('smart-links'),
            instructions: "The URL prefix for QR code pages (e.g., 'qr' creates /qr/your-link/view or 'go/qr' creates /go/qr/your-link/view)"|t('smart-links'),
            id: 'qrPrefix',
            name: 'settings[qrPrefix]',
            value: qrPrefixValue,
            errors: settings.getErrors('qrPrefix'),
            placeholder: settings.slugPrefix ~ '/qr',
            required: true,
            tip: qrTip|t('smart-links'),
            disabled: settings.isOverriddenByConfig('qrPrefix'),
            warning: settings.isOverriddenByConfig('qrPrefix') ?
                "This is being overridden by the <code>qrPrefix</code> setting in <code>config/smart-links.php</code>."|t('smart-links')|raw : null,
        }) }}

        <hr>

        <h2>{{ "Template Settings"|t('smart-links') }}</h2>

        {{ forms.textField({
            label: "Redirect Template"|t('smart-links'),
            instructions: "Path to your Redirect template in your templates/ folder (e.g., smart-links/redirect)"|t('smart-links'),
            id: 'redirectTemplate',
            name: 'settings[redirectTemplate]',
            value: settings.redirectTemplate ?? '',
            placeholder: 'smart-links/redirect',
            tip: "Copy reference template from <code>plugins/smart-links/src/templates/redirect.twig</code> to <code>templates/smart-links/redirect.twig</code>"|t('smart-links')|raw,
            disabled: settings.isOverriddenByConfig('redirectTemplate'),
            warning: settings.isOverriddenByConfig('redirectTemplate') ?
                "This is being overridden by the <code>redirectTemplate</code> setting in <code>config/smart-links.php</code>."|t('smart-links')|raw : null,
        }) }}

        {{ forms.textField({
            label: "QR Code Template"|t('smart-links'),
            instructions: "Path to your QR Code template in your templates/ folder (e.g., smart-links/qr)"|t('smart-links'),
            id: 'qrTemplate',
            name: 'settings[qrTemplate]',
            value: settings.qrTemplate ?? '',
            placeholder: 'smart-links/qr',
            tip: "Copy reference template from <code>plugins/smart-links/src/templates/qr.twig</code> to <code>templates/smart-links/qr.twig</code>"|t('smart-links')|raw,
            disabled: settings.isOverriddenByConfig('qrTemplate'),
            warning: settings.isOverriddenByConfig('qrTemplate') ?
                "This is being overridden by the <code>qrTemplate</code> setting in <code>config/smart-links.php</code>."|t('smart-links')|raw : null,
        }) }}

        <hr>

        <h2>{{ "Asset Settings"|t('smart-links') }}</h2>

        {# Asset volume selection dropdown for Smart Link images #}
        {% set volumeOptions = [{label: 'All asset volumes'|t('smart-links'), value: ''}] %}
        {% for volume in craft.app.volumes.getAllVolumes() %}
            {% set volumeOptions = volumeOptions|merge([{
                label: volume.name,
                value: volume.uid
            }]) %}
        {% endfor %}

        {{ forms.selectField({
            label: "{singularName} Image Volume"|t('smart-links', {singularName: singularName}),
            instructions: "Which asset volume should be used for {singularName} images"|t('smart-links', {singularName: singularName}),
            id: 'imageVolumeUid',
            name: 'settings[imageVolumeUid]',
            options: volumeOptions,
            value: settings.imageVolumeUid ?? '',
            disabled: settings.isOverriddenByConfig('imageVolumeUid'),
            warning: settings.isOverriddenByConfig('imageVolumeUid') ?
                "This is being overridden by the <code>imageVolumeUid</code> setting in <code>config/smart-links.php</code>."|t('smart-links')|raw : null,
        }) }}

        <hr>

        <h2>{{ "Logging Settings"|t('smart-links') }}</h2>

        {% set logOptions = [
            {value: 'error', label: 'Error (Critical errors only)'|t('smart-links')},
            {value: 'warning', label: 'Warning (Errors and warnings)'|t('smart-links')},
            {value: 'info', label: 'Info (General information)'|t('smart-links')},
        ] %}

        {% if craft.app.config.general.devMode %}
            {% set logOptions = logOptions|merge([
                {value: 'debug', label: 'Debug (Detailed debugging)'|t('smart-links')}
            ]) %}
        {% endif %}

        {{ forms.selectField({
            label: "Log Level"|t('smart-links'),
            instructions: craft.app.config.general.devMode ?
                "Choose what types of messages to log. Debug level requires devMode to be enabled."|t('smart-links') :
                "Choose what types of messages to log. Debug level requires devMode to be enabled."|t('smart-links'),
            id: 'logLevel',
            name: 'settings[logLevel]',
            value: settings.logLevel,
            options: logOptions,
            disabled: settings.isOverriddenByConfig('logLevel'),
            warning: settings.isOverriddenByConfig('logLevel') ?
                "This is being overridden by the <code>logLevel</code> setting in <code>config/smart-links.php</code>."|t('smart-links')|raw : null,
        }) }}

        <div class="buttons">
            <button type="submit" class="btn submit">{{ "Save Settings"|t('smart-links') }}</button>
        </div>
    </form>

    {% include 'smart-links/_components/plugin-credit.twig' %}
{% endblock %}
