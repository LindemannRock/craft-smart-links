{% extends "smart-links/_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set title = "Settings"|t('smart-links') %}
{% set fullPageForm = true %}
{% set selectedSubnavItem = 'settings' %}

{# Set up breadcrumbs #}
{% set crumbs = [
    {
        label: "Settings"|t('smart-links'),
        url: url('smart-links/settings')
    }
] %}

{% block content %}
    <form method="post" accept-charset="UTF-8">
        {{ actionInput('smart-links/settings/save') }}
        {{ csrfInput() }}
        {{ redirectInput('smart-links/settings') }}

        <div id="settings-content">
            <h2>{{ "General Settings"|t('smart-links') }}</h2>

            {{ forms.lightswitchField({
                label: "Enable Analytics"|t('smart-links'),
                instructions: "Track clicks and visitor data for smart links"|t('smart-links'),
                id: 'enableAnalytics',
                name: 'settings[enableAnalytics]',
                on: settings.enableAnalytics ?? true,
            }) }}

            {{ forms.textField({
                label: "Analytics Retention"|t('smart-links'),
                instructions: "How many days to keep analytics data (0 for unlimited, max 3650)"|t('smart-links'),
                id: 'analyticsRetention',
                name: 'settings[analyticsRetention]',
                value: settings.analyticsRetention ?? 90,
                type: 'number',
                min: 0,
                max: 3650,
                errors: settings.getErrors('analyticsRetention')
            }) }}
            
            {% if settings.analyticsRetention > 0 %}
                <div class="field" style="margin-top: 20px;">
                    <div class="heading">
                        <label>{{ "Analytics Cleanup"|t('smart-links') }}</label>
                        <div class="instructions">
                            <p>{{ "Analytics data older than {days} days will be automatically cleaned up daily."|t('smart-links', {days: settings.analyticsRetention}) }}</p>
                        </div>
                    </div>
                    <button type="button" class="btn" id="cleanup-analytics-now">
                        {{ "Clean Up Now"|t('smart-links') }}
                    </button>
                </div>
            {% elseif settings.analyticsRetention == 0 %}
                <div class="field" style="margin-top: 20px;">
                    <div class="heading">
                        <label>{{ "Unlimited Retention Warning"|t('smart-links') }}</label>
                        <div class="instructions" style="color: #da5a47;">
                            <p><strong>{{ "Warning"|t('smart-links') }}:</strong> {{ "Analytics data will be retained indefinitely. This could result in large database size, slower performance, and increased storage costs over time. Consider setting a retention period (recommended: 90-365 days) for production sites."|t('smart-links') }}</p>
                        </div>
                    </div>
                </div>
            {% endif %}

            <hr>

            <h2>{{ "Export Settings"|t('smart-links') }}</h2>

            {{ forms.lightswitchField({
                label: "Include Disabled Smart Links in Export"|t('smart-links'),
                instructions: "When enabled, analytics exports will include data from disabled smart links"|t('smart-links'),
                id: 'includeDisabledInExport',
                name: 'settings[includeDisabledInExport]',
                on: settings.includeDisabledInExport ?? false,
            }) }}

            {{ forms.lightswitchField({
                label: "Include Expired Smart Links in Export"|t('smart-links'),
                instructions: "When enabled, analytics exports will include data from expired smart links"|t('smart-links'),
                id: 'includeExpiredInExport',
                name: 'settings[includeExpiredInExport]',
                on: settings.includeExpiredInExport ?? false,
            }) }}

            <hr>

            <h2>{{ "QR Code Settings"|t('smart-links') }}</h2>

            {{ forms.textField({
                label: "Default QR Code Size"|t('smart-links'),
                instructions: "Default size in pixels for generated QR codes"|t('smart-links'),
                id: 'defaultQrCodeSize',
                name: 'settings[defaultQrSize]',
                value: settings.defaultQrSize ?? 256,
                type: 'number',
                min: 100,
                max: 1000,
            }) }}

            {{ forms.colorField({
                label: "Default QR Code Color"|t('smart-links'),
                id: 'defaultQrCodeColor',
                name: 'settings[defaultQrColor]',
                value: settings.defaultQrColor ?? '#000000',
            }) }}

            {{ forms.colorField({
                label: "Default QR Code Background"|t('smart-links'),
                id: 'defaultQrCodeBgColor',
                name: 'settings[defaultQrBgColor]',
                value: settings.defaultQrBgColor ?? '#FFFFFF',
            }) }}
            
            {{ forms.selectField({
                label: "Default QR Code Format"|t('smart-links'),
                instructions: "Default format for generated QR codes"|t('smart-links'),
                id: 'defaultQrFormat',
                name: 'settings[defaultQrFormat]',
                value: settings.defaultQrFormat ?? 'png',
                options: [
                    {label: 'PNG', value: 'png'},
                    {label: 'SVG', value: 'svg'},
                ],
            }) }}

            <hr>

            <h2>{{ "Redirect Settings"|t('smart-links') }}</h2>

            {{ forms.lightswitchField({
                label: "Enable Geographic Detection"|t('smart-links'),
                instructions: "Detect user location for analytics"|t('smart-links'),
                id: 'enableGeoDetection',
                name: 'settings[enableGeoDetection]',
                on: settings.enableGeoDetection ?? false,
            }) }}

            {{ forms.selectField({
                label: "Language Detection Method"|t('smart-links'),
                instructions: "How to detect user language preference"|t('smart-links'),
                id: 'languageDetectionMethod',
                name: 'settings[languageDetectionMethod]',
                value: settings.languageDetectionMethod ?? 'browser',
                options: [
                    {label: 'Browser preference', value: 'browser'},
                    {label: 'IP geolocation', value: 'ip'},
                    {label: 'Both', value: 'both'},
                ],
            }) }}

            
            {{ forms.textField({
                label: "Custom Redirect Template"|t('smart-links'),
                instructions: "Path to custom template for desktop redirects (optional)"|t('smart-links'),
                id: 'redirectTemplate',
                name: 'settings[redirectTemplate]',
                value: settings.redirectTemplate ?? '',
                placeholder: 'smart-links/redirect',
            }) }}
            
            {{ forms.textField({
                label: "404 Redirect URL"|t('smart-links'),
                instructions: "Where to redirect when a smart link is not found or disabled"|t('smart-links'),
                id: 'notFoundRedirectUrl',
                name: 'settings[notFoundRedirectUrl]',
                value: settings.notFoundRedirectUrl ?? '/',
                placeholder: '/',
                tip: 'Can be a relative path (/) or full URL (https://example.com)'|t('smart-links'),
            }) }}

            <hr>

            <h2>{{ "Interface Settings"|t('smart-links') }}</h2>

            {{ forms.textField({
                label: "Items Per Page"|t('smart-links'),
                instructions: "Number of smart links to show per page"|t('smart-links'),
                id: 'itemsPerPage',
                name: 'settings[itemsPerPage]',
                value: settings.itemsPerPage ?? 100,
                type: 'number',
                min: 10,
                max: 500,
                errors: settings.getErrors('itemsPerPage')
            }) }}

            <hr>

            <h2>{{ "Advanced Settings"|t('smart-links') }}</h2>

            {{ forms.lightswitchField({
                label: "Cache Device Detection"|t('smart-links'),
                instructions: "Cache device detection results for better performance"|t('smart-links'),
                id: 'cacheDeviceDetection',
                name: 'settings[cacheDeviceDetection]',
                on: settings.cacheDeviceDetection ?? true,
            }) }}

            {{ forms.textField({
                label: "Device Detection Cache Duration"|t('smart-links'),
                instructions: "Cache duration in seconds"|t('smart-links'),
                id: 'deviceDetectionCacheDuration',
                name: 'settings[deviceDetectionCacheDuration]',
                value: settings.deviceDetectionCacheDuration ?? 3600,
                type: 'number',
                min: 0,
            }) }}

            {{ forms.textField({
                label: "QR Code Cache Duration"|t('smart-links'),
                instructions: "How long to cache generated QR codes (in seconds)"|t('smart-links'),
                id: 'qrCodeCacheDuration',
                name: 'settings[qrCodeCacheDuration]',
                value: settings.qrCodeCacheDuration ?? 86400,
                type: 'number',
                min: 0,
            }) }}

            <hr>

            <h2>{{ "Permissions"|t('smart-links') }}</h2>

            <div class="field">
                <div class="heading">
                    <label>{{ "Default Permissions"|t('smart-links') }}</label>
                    <div class="instructions">
                        <p>{{ "Configure default permissions for user groups"|t('smart-links') }}</p>
                    </div>
                </div>
                <div class="input">
                    <p>{{ "Permissions can be configured in Settings → Users → User Groups"|t('smart-links') }}</p>
                </div>
            </div>
        </div>

        <div class="buttons">
            <button type="submit" class="btn submit">{{ "Save Settings"|t('smart-links') }}</button>
        </div>
    </form>
{% endblock %}

{% js %}
    $('#cleanup-analytics-now').on('click', function() {
        if (!confirm('{{ "Are you sure you want to clean up old analytics data now?"|t('smart-links')|e('js') }}')) {
            return;
        }
        
        const $btn = $(this);
        $btn.addClass('loading').prop('disabled', true);
        
        $.ajax({
            url: '{{ actionUrl('smart-links/settings/cleanup-analytics')|raw }}',
            type: 'POST',
            dataType: 'json',
            data: {
                {{ craft.app.config.general.csrfTokenName }}: '{{ craft.app.request.csrfToken }}'
            },
            success: function(response) {
                if (response.success) {
                    Craft.cp.displayNotice(response.message || '{{ "Analytics cleanup job queued"|t('smart-links')|e('js') }}');
                } else {
                    Craft.cp.displayError(response.error || '{{ "Failed to queue cleanup job"|t('smart-links')|e('js') }}');
                }
            },
            error: function() {
                Craft.cp.displayError('{{ "Failed to queue cleanup job"|t('smart-links')|e('js') }}');
            },
            complete: function() {
                $btn.removeClass('loading').prop('disabled', false);
            }
        });
    });
{% endjs %}