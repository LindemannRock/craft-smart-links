{% extends "smart-links/_layouts/settings" %}
{% set title = "Cache Settings"|t('smart-links') %}
{% set fullPageForm = true %}
{% set selectedSettingsItem = 'cache' %}

{% set plugin = craft.app.plugins.getPlugin('smart-links') %}{% set crumbs = [
    {
        label: smartlinkHelper.fullName|t('smart-links'),
        url: url('smart-links'),
    },
    {
        label: 'Settings'|t('smart-links'),
        url: url('smart-links/settings'),
    },
    {
        label: 'Cache'|t('smart-links'),
        url: url('smart-links/settings/cache'),
    },
] %}

{% import "_includes/forms" as forms %}

{% block content %}
    {% include 'smart-links/_components/ip-salt-error' %}

    <form method="post" accept-charset="UTF-8">
        {{ actionInput('smart-links/settings/save') }}
        {{ csrfInput() }}
        {{ redirectInput('smart-links/settings/cache') }}
        {{ hiddenInput('section', 'cache') }}

        <h2 style="margin-top: 0px;">{{ "Cache Storage Settings"|t('smart-links') }}</h2>

        {{ forms.selectField({
            label: 'Cache Storage Method'|t('smart-links'),
            instructions: 'How to store cache data. Use Redis/Database for load-balanced or multi-server environments.'|t('smart-links'),
            id: 'cacheStorageMethod',
            name: 'settings[cacheStorageMethod]',
            value: settings.cacheStorageMethod ?? 'file',
            options: [
                { value: 'file', label: 'File System (default, single server)'|t('smart-links') },
                { value: 'redis', label: 'Redis/Database (load-balanced, multi-server, cloud hosting)'|t('smart-links') },
            ],
            disabled: settings.isOverriddenByConfig('cacheStorageMethod'),
            warning: settings.isOverriddenByConfig('cacheStorageMethod') ?
                "This is being overridden by the <code>cacheStorageMethod</code> setting in <code>config/smart-links.php</code>."|t('smart-links')|raw : null,
        }) }}

        {% set craftUsesRedis = craft.app.cache is defined and craft.app.cache.className is defined and craft.app.cache.className == 'yii\\redis\\Cache' %}

        <div id="cache-location-file" class="{{ (settings.cacheStorageMethod ?? 'file') == 'redis' ? 'hidden' }}">
            {% include 'smart-links/_components/info-box' with {
                message: '<strong>Cache Location:</strong> <code>storage/runtime/smart-links/cache/</code>',
                type: 'info'
            } %}
        </div>

        <div id="cache-location-redis" class="{{ (settings.cacheStorageMethod ?? 'file') == 'file' ? 'hidden' }}">
            {% if craftUsesRedis %}
                {% include 'smart-links/_components/info-box' with {
                    type: 'success',
                    message: '<strong>Cache Location:</strong> Using Craft\'s configured Redis cache from <code>config/app.php</code>'
                } %}
            {% else %}
                {% include 'smart-links/_components/info-box' with {
                    type: 'warning',
                    message: '<strong>Redis Not Configured:</strong> To use Redis caching, install <code>yiisoft/yii2-redis</code> and configure it in <code>config/app.php</code>. <a href="https://craftcms.com/docs/5.x/reference/config/app.html#cache" target="_blank" rel="noopener">Learn more</a>'
                } %}
            {% endif %}
        </div>

        <hr>

        <h2>{{ "QR Code Caching"|t('smart-links') }}</h2>

        {{ forms.lightswitchField({
            label: "Enable QR Code Cache"|t('smart-links'),
            instructions: "Cache generated QR codes for better performance"|t('smart-links'),
            id: 'enableQrCodeCache',
            name: 'settings[enableQrCodeCache]',
            on: settings.enableQrCodeCache ?? true,
            toggle: 'qr-cache-settings',
            disabled: settings.isOverriddenByConfig('enableQrCodeCache'),
            warning: settings.isOverriddenByConfig('enableQrCodeCache') ?
                "This is being overridden by the <code>enableQrCodeCache</code> setting in <code>config/smart-links.php</code>."|t('smart-links')|raw : null,
        }) }}

        <div id="qr-cache-settings" class="{{ not (settings.enableQrCodeCache ?? true) ? 'hidden' }}">
            {{ forms.textField({
                label: "QR Code Cache Duration"|t('smart-links'),
                instructions: "How long to cache generated QR codes (in seconds). Default: 86400 (24 hours)"|t('smart-links'),
                id: 'qrCodeCacheDuration',
                name: 'settings[qrCodeCacheDuration]',
                value: settings.qrCodeCacheDuration ?? 86400,
                type: 'number',
                min: 0,
                disabled: settings.isOverriddenByConfig('qrCodeCacheDuration'),
                warning: settings.isOverriddenByConfig('qrCodeCacheDuration') ?
                    "This is being overridden by the <code>qrCodeCacheDuration</code> setting in <code>config/smart-links.php</code>."|t('smart-links')|raw : null,
            }) }}

            <div class="field">
                <p class="light">
                    <strong>Tips:</strong><br>
                    • Higher values reduce server load but may show outdated QR codes after settings changes<br>
                    • Set to 0 to disable caching (not recommended for production)
                </p>
            </div>
        </div>

        {% if settings.enableAnalytics ?? true %}
            <hr>

            <h2>{{ "Device Detection Caching"|t('smart-links') }}</h2>

            {{ forms.lightswitchField({
                label: "Cache Device Detection"|t('smart-links'),
                instructions: "Cache device detection results for better performance"|t('smart-links'),
                id: 'cacheDeviceDetection',
                name: 'settings[cacheDeviceDetection]',
                on: settings.cacheDeviceDetection ?? true,
                toggle: 'device-cache-settings',
                disabled: settings.isOverriddenByConfig('cacheDeviceDetection'),
                warning: settings.isOverriddenByConfig('cacheDeviceDetection') ?
                    "This is being overridden by the <code>cacheDeviceDetection</code> setting in <code>config/smart-links.php</code>."|t('smart-links')|raw : null,
            }) }}

            <div id="device-cache-settings" class="{{ not (settings.cacheDeviceDetection ?? true) ? 'hidden' }}">
                {{ forms.textField({
                    label: "Device Detection Cache Duration"|t('smart-links'),
                    instructions: "Cache duration in seconds. Default: 3600 (1 hour)"|t('smart-links'),
                    id: 'deviceDetectionCacheDuration',
                    name: 'settings[deviceDetectionCacheDuration]',
                    value: settings.deviceDetectionCacheDuration ?? 3600,
                    type: 'number',
                    min: 0,
                    disabled: settings.isOverriddenByConfig('deviceDetectionCacheDuration'),
                    warning: settings.isOverriddenByConfig('deviceDetectionCacheDuration') ?
                        "This is being overridden by the <code>deviceDetectionCacheDuration</code> setting in <code>config/smart-links.php</code>."|t('smart-links')|raw : null,
                }) }}

                <div class="field">
                    <p class="light">
                        <strong>How it works:</strong><br>
                        • Device detection parses user-agent strings to identify devices, browsers, and operating systems<br>
                        • Results are cached to avoid re-parsing the same user-agent repeatedly<br>
                        • Recommended to keep enabled for production sites
                    </p>
                </div>
            </div>
        {% else %}
            <hr>

            <h2>{{ "Device Detection Caching"|t('smart-links') }}</h2>

            <div class="field">
                <p class="light" style="color: #999;">
                    {{ "Device detection caching is only available when Analytics is enabled. Go to"|t('smart-links') }}
                    <a href="{{ url('smart-links/settings/analytics') }}">{{ "Analytics Settings"|t('smart-links') }}</a>
                    {{ "to enable analytics."|t('smart-links') }}
                </p>
            </div>
        {% endif %}

        <div class="buttons">
            <button type="submit" class="btn submit">{{ "Save Settings"|t('smart-links') }}</button>
        </div>
    </form>

    {% include 'smart-links/_components/plugin-credit.twig' %}
{% endblock %}

{% js %}
// Toggle cache location info boxes based on storage method selection
$('#cacheStorageMethod').on('change', function() {
    const value = $(this).val();
    if (value === 'redis') {
        $('#cache-location-file').addClass('hidden');
        $('#cache-location-redis').removeClass('hidden');
    } else {
        $('#cache-location-redis').addClass('hidden');
        $('#cache-location-file').removeClass('hidden');
    }
});
{% endjs %}
